# 管理事务处理

## 事务处理

使用事务处理，通过确保成批的SQL操作要么完全执行，要么完全不执行，来维护数据库的完整性。

例如订单存储在`Orders`和`OrderItems`两个表中，如果我们需要添加一个订单的话：

1. 检查数据库是否存在相应的顾客，如果不存在添加他
2. 检索顾客ID
3. 在Orders表中添加一行，与顾客ID相关联
4. 检索Orders表中赋予的新订单ID
5. 为订购的每一个物品在OrderItems表中添加一行，并通过检索出来的ID与Orders表关联

如果在执行这一系列的过程时，数据库出现什么错误，则数据库中会存在一些不完整的订单，这时我们就可以使用**事务处理**来解决了，所谓的事务处理就是用来管理必须成批执行的SQL操作，保证数据库不包含不完整的操作结果的一种机制，即如果在执行过程中发生故障，则进行回退，将数据库回复到某个已知且安全的状态。

几个术语：

- 事务(transaction)指一组SQL语句
- 回退(rollback)指撤销指定SQL语句的过程
- 提交(commit)指将未存储的SQL语句的过程
- 保留点(savepoint)指事务处理中设置的临时占位符，可以对它发布回退(与回退整个事务处理不同)

**事务处理用来管理`INSERT`、`UPDATE`和`DELETC`语句**.不能回退`SELECT`语句，也不能回退`CREATE`和`DROP`操作。

## 控制事务处理

**不同的DBMS实现事务处理的语法有所不同**。

```sql
START TRANSACTION;

-- some sql

COMMIT;
```

### 使用ROLLBACK

SQL的ROLLBACK命令用来回退SQL语句。

```sql
DELETE FROM Orders;
ROLLBACK;
```

### 使用COMMIT

一般SQL语句都是针对数据库直接执行和编写的，就是所谓的隐式提交，即提交（写或保存）操作是自动进行的。

在事务处理块中不会隐式提交，需要用`COMMIT`进行明确的提交.

### 使用保留点

有时我们不需要回退整个事务处理，只需要回退部分即可，这时必须在事务处理块中的适合位置放置占位符，这样，如果需要回退的话，可以回退到某个占位符。

在SQL中，这些占位符被称为保留点。

使用`SAVEPOINT`语句创建占位符：

```SQL
SAVEPOINT delete1;
```

**每个占位符都需要一个唯一标识其的名字**，以便在回退时，DBMS指定回退到何处。

回退到保留点

```sql
ROLLBACK TO delete1;
```

**保留点越多越好**，这样能够更灵活的回退。